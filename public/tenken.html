<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコード読み取り (画像アップロード)</title>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <style>
        #camera-canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            width: 100%;  
            height: auto;
        }
        #qr-msg {
            font-size: 1.2em;
            color: green;
            text-align: center;
            margin-top: 20px;
        }
        #download-container, #upload-container {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">QRコード読み取り</h1>

    <!-- 画像アップロード -->
    <input type="file" id="upload-image" capture="environment" accept="image/*">
    <canvas id="camera-canvas"></canvas>
    <p id="qr-msg">QRコードがここに表示されます</p>
    <div id="download-container"></div> <!-- ダウンロードリンク表示用 -->
    <div id="upload-container">
        <input type="file" id="file-upload" accept=".xlsx">
        <button id="upload-btn">ファイルをアップロード</button>
    </div>

    <script>
        const uploadImage = document.getElementById('upload-image');
        const canvas = document.getElementById('camera-canvas');
        const ctx = canvas.getContext('2d');
        const qrMsg = document.getElementById('qr-msg');
        const downloadContainer = document.getElementById('download-container');
        const fileUpload = document.getElementById('file-upload');
        const uploadBtn = document.getElementById('upload-btn');
        let downloadUrl = '';

        uploadImage.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const maxDimension = 640;
                    let imgWidth = img.width;
                    let imgHeight = img.height;

                    if (imgWidth > maxDimension || imgHeight > maxDimension) {
                        const scale = maxDimension / Math.max(imgWidth, imgHeight);
                        imgWidth *= scale;
                        imgHeight *= scale;
                    }

                    canvas.width = imgWidth;
                    canvas.height = imgHeight;
                    ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

                    const imageData = ctx.getImageData(0, 0, imgWidth, imgHeight);
                    const code = jsQR(imageData.data, imgWidth, imgHeight);
                    if (code) {
                        qrMsg.textContent = `QRコード: ${code.data}`;
                        handleQrCodeData(code.data);
                    } else {
                        qrMsg.textContent = "QRコード: 見つかりません";
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        function handleQrCodeData(data) {
            downloadUrl = `/download?filePath=${encodeURIComponent(data)}`;
            qrMsg.innerText = "以下のボタンでファイルをダウンロードできます。";
            const downloadButton = document.createElement('a');
            downloadButton.href = downloadUrl;
            downloadButton.download = "";
            downloadButton.innerText = "ファイルをダウンロード";
            downloadButton.style.display = "inline-block";
            downloadButton.style.marginTop = "10px";
            downloadButton.style.padding = "10px";
            downloadButton.style.color = "white";
            downloadButton.style.backgroundColor = "#4CAF50";
            downloadButton.style.textDecoration = "none";
            downloadButton.style.borderRadius = "5px";
            downloadContainer.innerHTML = '';
            downloadContainer.appendChild(downloadButton);
        }

        uploadBtn.addEventListener('click', () => {
            const file = fileUpload.files[0];
            if (!file) {
                alert("アップロードするファイルを選択してください。");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                alert(result);
            })
            .catch(error => {
                console.error("アップロードエラー:", error);
            });
        });
    </script>
</body>
</html>

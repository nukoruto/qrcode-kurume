<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコード読み取り (画像アップロード)</title>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <style>
        #camera-canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            width: 100%;  
            height: auto;
        }
        #qr-msg {
            font-size: 1.2em;
            color: green;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">QRコード読み取り</h1>

    <!-- 画像アップロード -->
    <input type="file" id="upload-image" accept="image/*">
    <!-- QRコード検出領域を描画するキャンバス -->
    <canvas id="camera-canvas"></canvas>
    <p id="qr-msg">QRコードがここに表示されます</p>

    <script>
        const uploadImage = document.getElementById('upload-image');
        const canvas = document.getElementById('camera-canvas');
        const ctx = canvas.getContext('2d');
        const qrMsg = document.getElementById('qr-msg');

        uploadImage.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // QRコード認識精度向上のため、画像をリサイズしてキャンバスに描画
                    const maxDimension = 640;  // 解析に最適なサイズを指定
                    let imgWidth = img.width;
                    let imgHeight = img.height;

                    if (imgWidth > maxDimension || imgHeight > maxDimension) {
                        const scale = maxDimension / Math.max(imgWidth, imgHeight);
                        imgWidth *= scale;
                        imgHeight *= scale;
                    }

                    canvas.width = imgWidth;
                    canvas.height = imgHeight;
                    ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

                    // QRコードの解析
                    const imageData = ctx.getImageData(0, 0, imgWidth, imgHeight);
                    const code = jsQR(imageData.data, imgWidth, imgHeight);
                    if (code) {
                        console.log("QRコードが見つかりました:", code);
                        qrMsg.textContent = `QRコード: ${code.data}`;
                        handleQrCodeData(code.data); // QRコードの内容を処理
                    } else {
                        console.log("QRコードが見つかりません");
                        qrMsg.textContent = "QRコード: 見つかりません";
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // QRコードのデータを処理する既存の関数
        function handleQrCodeData(data) {
            fetch(`/copy-and-share?fileName=${encodeURIComponent(data)}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const fileLink = document.createElement('a');
                        fileLink.href = `ms-excel:ofe|u|${result.networkPath}`;
                        fileLink.innerText = "コピーされたファイルをExcelで開く";
                        fileLink.target = "_blank";

                        qrMsg.innerHTML = "ファイルのコピーが完了しました。以下のリンクをタップして開いてください。";
                        qrMsg.appendChild(fileLink);
                    } else {
                        qrMsg.innerText = "ファイルのコピーに失敗しました";
                    }
                })
                .catch(error => {
                    console.error("QRコードデータ処理エラー:", error);
                    qrMsg.innerText = "エラーが発生しました";
                });
        }
    </script>
</body>
</html>
